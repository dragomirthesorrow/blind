<?php
/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * Description of Modect
 *
 * @author a.onischenko
 */
include_once ('/var/www/html/configs/interval.config');
require_once ('/var/www/html/modules/modect/classes/Compare.php');
require_once ('/var/www/html/classes/connect.php');
$difference=$MIN_DIFF;

class Modect {

    //put your code here
   /* public function GetImages($path){
        $this->id=$path;
        //Получаем время старта записи
        $sql_get_startrec="select * from `log_record` where `id_monitor`='$this->id'";
        $startrec=new Connection($sql_get_startrec);
        $start_rec=$startrec->Connect();
        $start_time=$start_rec['start_time'];
//system("ffmpeg -ss 1 00:00:00 /var/www/html/modules/record/'$cam_name'/record.avi");
    }*/
    public function DetectTheBeginning($name,$id_mon) {
        $this->name=$name;
	$this->id=$id_mon;
//echo $this->name.'monitor';
//!!! Проверяем - нет ли сейчас события с моника, если нет, то пропускаем все это и переходим к мониторингу завершения.

	$sql_event_now="select * from `events` where `monitor_id`='$this->id' and `end_time` IS NULL";
	$event_now=new Connection($sql_event_now);
	$now=$event_now->Connect();

	if(empty($now)){
//Получаем все картинки из директории девайса

$direct='/var/www/html/modules/record/devices/'.$this->name.'/*.jpg';//*/
$filelist = glob($direct);
//$max_filename=max($filelist);
//print_r($filelist);

//Получаем длинну массива
$c=count($filelist);
//Выдергиваем последнее изображение и предпоследнее
$c=$c-1;
$last_im=$filelist[$c];
$c2=$c-1;
$pre_last_img=$filelist[$c2];

//echo $last_im.'/';
//echo $pre_last_img.'/';
//echo $c;




//        $image2_prefix_name=date("YmdHis");
//	$image1_prefix_name=$image1_prefix_name-1;
	$image1 = new imagick($last_im);
	$image2 = new imagick($pre_last_img);
	//system("rm /var/www/html/modules/record/devices/'.$this->name.'/t2.jpg'");//!!!!!!!!
	//system("rm /var/www/html/modules/record/devices/'.$this->name.'/t1.jpg'");
	$result = $image1->compareImages ($image2,  Imagick::METRIC_MEANSQUAREERROR);
	$diff = round($result[1]*100000,5);
//echo $diff.'!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!';
      //echo $difference;
	if($diff>'80'){
//              echo 'There is the motion';
		$time=date("Y-m-d H:i:s");
		//Write the event into event base and log
		$sql_add_event="insert into `events` (`id`,`start_time`,`end_time`,`monitor_id`) values (NULL,'$time',NULL,'$this->id')";
		$add_event=new Connection($sql_add_event);
		$add_event->Connect();
		$get_event_id="select * from `events` where `start_time`='$time' and `monitor_id`='$this->id'";
		$event_id=new Connection($get_event_id);
		$event=$event_id->Connect();
		$id_event=$event['0']['id'];
		$log_text='<p>'.$time.' Зафиксировано событие: '.$id_event.'</p>';
		$file1=fopen('/var/www/html/log.txt',"a");
	        fwrite ($file1, $log_text);
      }else{
            	exit;
$this->DetectEnd($this->name,$this->id);
        }
}else{
$this->DetectEnd($this->name,$this->id);
}
    }

   public function DetectTheEnd($name,$id_mon) {
        $this->name=$name;
	$this->id=$id_mon;
//Проверяем движение на камере ныне
$direct='/var/www/html/modules/record/devices/'.$this->name.'/*.jpg';//*/
$filelist = glob($direct);
//$max_filename=max($filelist);
//print_r($filelist);

//Получаем длинну массива
$c=count($filelist);
//Выдергиваем последнее изображение и предпоследнее
$c=$c-1;
$last_im=$filelist[$c];
$c2=$c-1	;
	$pre_last_img=$filelist[$c2];
        $image1 = new imagick($last_im);
        $image2 = new imagick($pre_last_img);
        //system("rm /var/www/html/modules/record/devices/'.$this->name.'/t2.jpg'");//!!!!!!!!
        //system("rm /var/www/html/modules/record/devices/'.$this->name.'/t1.jpg'");
        $result = $image1->compareImages ($image2,  Imagick::METRIC_MEANSQUAREERROR);
        $diff = round($result[1]*100000,5);


//Выбираем опять последние картинки и сравниваем

//Смотрим сколько уже идет запись без изменений, если более 10сек, то режим ее к хренам собачим



/*	$da=date("Y-m-d H:i:s");
	$image_prefix_name=date("Ymd_His");
        $image1 = new imagick('/var/www/html/modules/record/devices/'.$this->name.'/1_'.$image_prefix_name.'.jpg');
        $image2 = new imagick('/var/www/html/modules/record/devices/'.$this->name.'/2_'.$image_prefix_name.'.jpg');
        $result = $image1->compareImages ($image2,  Imagick::METRIC_MEANSQUAREERROR);
        $diff = round($result[1]*100000,5);
	if($diff>$difference){
		//Стартуем процедуру завершения
		$sql_get_eid="select * from `events` where `monitor_id`='$this->id' and `end_time` IS NULL";
		$get_eid=new Connection($sql_get_eid);
		$eid=$get_eid->Connect();
		$ide=$eid['0']['id'];
		$sql_end_event="update `events` set `end_time`=CURRENT_TIMESTAMP where `end_time` IS NULL and `monitor_id`='$this->id'";
		$end_event=new Connection($sql_end_event);
		$end_event->Connect();
		$log_end='<p>'.$da.' Запись события завершена. Событие: '.$ide.'</p>';
		$file2=fopen('/var/www/html/log.txt',"a");
                fwrite ($file2, $log_end);
		system("rm /var/www/html/modules/record/devices/'$this->name'/1_'$image_prefix_name'.jpg'");
		system("rm /var/www/html/modules/record/devices/'$this->name'/2_'$image_prefix_name'.jpg'");

	}else{
		exit;
	}*/

    }


}

